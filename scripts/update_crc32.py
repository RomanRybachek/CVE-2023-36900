import zlib
import pwnlib.util.packing as pk
import sys

if len(sys.argv) < 2:
    print("\nUsage: python3 update_crc32.py path_to_blf\n")
    exit(1)

blf_path = sys.argv[1]
if blf_path.find(".blf") == -1:
    print("\nFile must have .blf extension.\n")
    exit(1)

new_name = blf_path.replace(".blf", "_updated.blf")
fd = open(blf_path, "rb")
part_for_crc = fd.read(0x400)
last_part = fd.read()

def calc_crc32(buf):
    part_before_checksum = buf[:0xc]
    part_aftetr_checksum = buf[0x10:]
    buf_with_zeroed_checksum = part_before_checksum + pk.p32(0) + part_aftetr_checksum
    crc32 = zlib.crc32(buf_with_zeroed_checksum)
    buf_with_correct_checksum = part_before_checksum + pk.p32(crc32) + part_aftetr_checksum
    print("CRC32:", hex(crc32))
    return buf_with_correct_checksum

buf_with_correct_checksum = calc_crc32(part_for_crc)
new_blf_file_buf = buf_with_correct_checksum + last_part

fd_w = open(new_name, "wb")
fd_w.write(new_blf_file_buf)
print(new_name, " is created!")
fd_w.close()
fd.close()

